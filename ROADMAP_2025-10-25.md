# AeroDynControlRig Development Roadmap

**Created:** 2025-10-25
**Vision Reference:** `vision/state_estimation_view/stitch_state_estimation_view/main_dashboard/screen.png`
**Goal:** Build toward the full dynamics loop with rich telemetry visualization matching the vision mocks

---

## Overview

This roadmap sequences the next development phase to match the vision mocks in `vision/state_estimation_view/`. The work is organized into 10 phases covering:

1. **Data Infrastructure** - Ring buffers for time-series data
2. **Plotting Infrastructure** - ImPlot integration for graphs
3. **Telemetry Visualization** - Attitude/rate plots matching Vision Mock 2
4. **Rotor Dynamics** - Per-rotor telemetry matching Vision Mock 1
5. **Scene Polish** - PBR lighting, skybox, post-processing
6. **UI Polish** - Cards, metrics, badges matching vision aesthetic
7. **Dynamics Integration** - Physics modules and EoMs
8. **State Estimation** - Kalman filter, INS pipeline
9. **Control Integration** - PID/LQR/MPC with tuning UI
10. **Data Export** - CSV export and log replay

**Estimated Timeline:** 6-8 weeks full-time (or 3-4 months part-time)

---

## Phase 1: Data Infrastructure - History Buffers

**Goal:** Add ring buffers to SimulationState for all time-series telemetry

### Tasks

- [ ] **1.1** Add ring buffer utility class (`src/core/ring_buffer.h`)
  - Template-based circular buffer with configurable depth
  - Timestamped samples (double timestamp, T data)
  - Thread-safe if needed for future async modules
  - Memory-efficient (fixed allocation, no dynamic growth)

- [ ] **1.2** Extend SimulationState with quaternion history buffer
  - `RingBuffer<glm::dquat> quaternion_history` (depth: 1000 samples)
  - Automatically sample every frame based on dt
  - Getter: `getQuaternionHistory(double time_window_sec)`

- [ ] **1.3** Add Euler angle history buffer
  - `RingBuffer<glm::dvec3> euler_history` (roll, pitch, yaw)
  - Computed from quaternion each frame
  - Same sampling rate as quaternion

- [ ] **1.4** Add angular rate (gyro) history buffer
  - `RingBuffer<glm::dvec3> angular_rate_history` (rad/s)
  - Directly from `SimulationState.angular_rate_deg_per_sec` (convert to rad/s)

- [ ] **1.5** Add rotor dynamics history buffers
  - `RingBuffer<RotorTelemetry> rotor_history[4]` (per-motor)
  - RotorTelemetry struct: `{double rpm, thrust_N, power_W, temp_C}`
  - Populated by RotorTelemetryModule

- [ ] **1.6** Add INS sensor history buffers
  - `RingBuffer<glm::dvec3> accelerometer_history` (m/s²)
  - `RingBuffer<glm::dvec3> gyroscope_history` (rad/s)
  - `RingBuffer<glm::dvec3> magnetometer_history` (µT)
  - `RingBuffer<glm::dvec3> position_history` (m)
  - `RingBuffer<glm::dvec3> velocity_history` (m/s)

- [ ] **1.7** Implement configurable sampling rate
  - Add `SimulationState.telemetry_sampling_hz` (default: 100 Hz)
  - Only sample buffers when `elapsed_time >= 1.0/sampling_hz`
  - Tie to fixed dt mode for predictable data density

**Estimated Time:** 3-4 days

**Dependencies:** None

**Deliverable:** SimulationState with rich history buffers, no visualization yet

---

## Phase 2: Plotting Infrastructure - ImPlot Integration

**Goal:** Integrate ImPlot library for time-series plotting

### Tasks

- [ ] **2.1** Add ImPlot as git submodule
  ```bash
  cd external/
  git submodule add https://github.com/epezent/implot.git
  git submodule update --init --recursive
  ```

- [ ] **2.2** Integrate ImPlot into CMakeLists.txt
  - Add `external/implot/` to include paths
  - Add ImPlot sources to build: `implot.cpp`, `implot_items.cpp`, `implot_demo.cpp`
  - Link ImPlot with imgui (already built)

- [ ] **2.3** Initialize ImPlot context in Application::init()
  ```cpp
  ImPlot::CreateContext();
  ```

- [ ] **2.4** Destroy ImPlot context in Application destructor
  ```cpp
  ImPlot::DestroyContext();
  ```

- [ ] **2.5** Create plotting utility wrapper (`src/gui/widgets/plot_widget.h`)
  - `plotTimeSeries()` - Single-channel time-series plot
  - `plotMultiChannel()` - Multi-channel overlaid plot (e.g., Roll/Pitch/Yaw)
  - `plotWithGradient()` - Plot with gradient area fill (matching vision)
  - Common config: grid, axes labels, tooltips, legends

**Estimated Time:** 1-2 days

**Dependencies:** None

**Deliverable:** ImPlot integrated and ready to use in panels

---

## Phase 3: Telemetry Panel - Attitude Graphs (Vision Mock 2)

**Goal:** Build Kalman Filter Performance panel matching `vision/state_estimation_view/2/`

### Tasks

- [ ] **3.1** Create new EstimatorPanel or extend existing
  - Left sidebar: "Control Panel" with sub-sections (Data Series, Sensor Inputs, Filter Parameters)
  - Main area: 3×2 grid of plots

- [ ] **3.2** Add Roll Angle (Raw vs. Estimated) plot
  - X-axis: Time (last 60s)
  - Y-axis: Roll angle (degrees)
  - Two lines: Raw (from gyro integration), Estimated (from Kalman)
  - Orange line for Raw, Cyan line for Estimated (matching vision)
  - Legend: top-right

- [ ] **3.3** Add Pitch Angle (Raw vs. Estimated) plot
  - Same format as Roll
  - Yellow/gold line for Raw, Green line for Estimated

- [ ] **3.4** Add Yaw Angle (Raw vs. Estimated) plot
  - Same format as Roll/Pitch
  - Gradient fill under estimated line (matching vision)

- [ ] **3.5** Add X-Axis Acceleration plot
  - Single channel: accelerometer X-axis (m/s²)
  - Purple/violet gradient fill
  - Current value display: "0.2 m/s²" with delta "Last 60s +0.5%"

- [ ] **3.6** Add time window controls
  - Radio buttons or dropdown: 10s / 30s / 60s
  - Updates all plots simultaneously
  - Stored in panel state

- [ ] **3.7** Add pause/resume button
  - Pauses buffer updates (freezes plots)
  - Icon button with play/pause Material Symbol

- [ ] **3.8** Add clear history button
  - Clears all buffers
  - Confirmation dialog (optional)

- [ ] **3.9** Add status badges
  - "Converged" / "Diverged" / "Installing" pill badges
  - Color-coded: green (converged), red (diverged), blue (installing)
  - Based on Kalman filter covariance threshold

**Estimated Time:** 4-5 days

**Dependencies:** Phase 1 (buffers), Phase 2 (ImPlot)

**Deliverable:** Estimator panel matching Vision Mock 2

---

## Phase 4: Rotor Dynamics Panel (Vision Mock 1)

**Goal:** Build rotor telemetry panel matching `vision/state_estimation_view/1/`

### Tasks

- [ ] **4.1** Create RotorAnalysisPanel with sidebar navigation
  - Left sidebar: Rotor 1/2/3/4 selection buttons
  - Each button shows rotor icon + label
  - Selected rotor highlighted (cyan background)

- [ ] **4.2** Add playback controls in top bar
  - Play / Pause / Skip buttons
  - Timeline scrubber (0:00 / 4:00 format)
  - "Export Data" button (top-right)

- [ ] **4.3** Add 3D Visualization card (left panel)
  - Same renderSceneToTexture output
  - Smaller viewport (fits in left column)

- [ ] **4.4** Add Thrust vs. Time plot (top-right)
  - Cyan line with gradient fill
  - Large metric display: "1.2N" with delta "Last 60s +0.1N"
  - X-axis: 0s - 60s gridlines

- [ ] **4.5** Add RPM vs. Time plot (middle-right)
  - Orange/yellow line with gradient fill
  - Large metric display: "1500 RPM" with delta "Last 60s -50 RPM"

- [ ] **4.6** Add Power Consumption vs. Time plot (bottom-left)
  - Cyan line matching vision aesthetic
  - Large metric display: "120W" with delta "Last 60s +5W"

- [ ] **4.7** Add Temperature vs. Time plot (bottom-right)
  - Orange line with gradient fill
  - Large metric display: "75°C" with delta "Last 60s +2°C"

- [ ] **4.8** Add Raw Data Log table (bottom-left panel)
  - Columns: Timestamp | Thrust (N) | RPM | Voltage (V)
  - Scrollable table with ImGui::BeginTable
  - Monospace font for numeric values
  - Last 10-20 samples visible

- [ ] **4.9** Add CSV export functionality
  - "Export Data" button triggers file dialog
  - Export current rotor's telemetry buffer to CSV
  - Format: timestamp, thrust, rpm, power, temp, voltage

**Estimated Time:** 5-6 days

**Dependencies:** Phase 1 (buffers), Phase 2 (ImPlot), Phase 5 (scene rendering)

**Deliverable:** Rotor dynamics panel matching Vision Mock 1

---

## Phase 5: Scene Rendering Polish

**Goal:** Upgrade 3D scene to match vision's cinematic aesthetic

### Tasks

- [ ] **5.1** Implement PBR/Phong lighting shader
  - Create new shader: `shaders/pbr_lit.vert` + `pbr_lit.frag`
  - Directional key light (45° from top-left, white)
  - Rim light (subtle highlight on edges, cyan tint)
  - Ambient term (dark blue-gray to match vision)

- [ ] **5.2** Add gradient skybox/background
  - Background quad rendered before scene
  - Vertical gradient: dark teal (top) → dark purple (bottom)
  - Matches vision's atmospheric glow

- [ ] **5.3** Add floor plane with grid
  - Large quad below drone (e.g., 20m × 20m)
  - Dark surface with subtle grid lines (1m spacing)
  - Helps spatial reference (pitch/roll easier to see)

- [ ] **5.4** Implement blob shadow for drone
  - Simple planar projection shadow
  - Dark ellipse on floor plane
  - Fades with altitude (drone height affects shadow opacity)

- [ ] **5.5** Add vignette post-process effect
  - Apply in renderSceneToTexture after scene render
  - Darken corners (radial gradient from center)
  - Subtle effect (opacity ~20-30%)

- [ ] **5.6** Add optional film grain post-process
  - Procedural noise overlay
  - Very subtle (adds texture, not distraction)
  - Toggle in settings

- [ ] **5.7** Upgrade drone 3D model
  - Replace wireframe cube with solid mesh
  - Add emissive edge lines (cyan glow on edges)
  - OR import higher-fidelity model from assets/ if available
  - Goal: match "hero object" look in vision

**Estimated Time:** 5-7 days

**Dependencies:** None (can work in parallel with Phase 3-4)

**Deliverable:** Cinematic 3D scene matching vision aesthetic

---

## Phase 6: UI Polish - Dashboard Aesthetic

**Goal:** Match vision's card styling, typography, and layout

### Tasks

- [ ] **6.1** Update card styling in `src/gui/widgets/card.cpp`
  - Background: `#111618` (darker than current)
  - Border: `#3b4b54` (softer blue-gray)
  - Border radius: 8px (rounded corners)
  - Padding: 16px inside cards

- [ ] **6.2** Add large metric display widget
  - Component: `ui::MetricDisplay(label, value, delta, color)`
  - Example: "1500 RPM" (large 32px font) + "Last 60s -50 RPM" (small 14px)
  - Delta color: green (+), red (-), gray (neutral)

- [ ] **6.3** Implement per-rotor bar chart visualization
  - Component: `ui::BarChart(labels[], values[], count)`
  - Used in Rotor Dynamics card for R1/R2/R3/R4 RPM
  - Cyan bars with gradient fill matching vision

- [ ] **6.4** Add status badge component
  - Component: `ui::StatusBadge(label, style)`
  - Styles: Primary (cyan), Success (green), Warning (yellow), Danger (red)
  - Pill-shaped (rounded-full), bold text
  - Examples: "Connected", "Autonomous", "Converged"

- [ ] **6.5** Add navigation tabs component
  - Component: `ui::TabBar(tabs[], active_index)`
  - Tabs: Dashboard, Raw Data, Error Analysis, Settings
  - Active tab: cyan underline + bold text
  - Inactive: muted gray text

- [ ] **6.6** Update typography in `src/gui/style.cpp`
  - Ensure Space Grotesk font loaded (or similar geometric sans-serif)
  - Heading: 22px bold
  - Body: 14px regular
  - Monospace: 14px (for numeric values)
  - Icon font: Material Symbols 20px

**Estimated Time:** 3-4 days

**Dependencies:** None

**Deliverable:** UI components matching vision design system

---

## Phase 7: Dynamics Integration

**Goal:** Wire physics modules into plotting infrastructure

### Tasks

- [ ] **7.1** Resurrect FirstOrderDynamicsModule
  - Re-enable in Application::initializeModules()
  - Verify it updates SimulationState correctly
  - Add history buffer for system output

- [ ] **7.2** Resurrect RotorTelemetryModule
  - Re-enable in Application::initializeModules()
  - Ensure it populates rotor_history buffers
  - Calculate thrust, power, temperature based on RPM

- [ ] **7.3** Extend SimulationState for full dynamics
  - Add `glm::dvec3 linear_acceleration` (m/s²)
  - Add `glm::dvec3 forces_body` (N, in body frame)
  - Add `glm::dvec3 commanded_attitude` (setpoint from controller)
  - Add `double commanded_thrust` (N)

- [ ] **7.4** Add feature flag for full quadrotor EoMs
  - `SimulationState.control.enable_full_dynamics` (default: false)
  - When enabled, use full Newton-Euler equations
  - Integrate with `dynamic_models/` library (external submodule)

- [ ] **7.5** Wire physics outputs to buffers
  - Sample acceleration → accelerometer_history
  - Sample forces → new forces_history buffer
  - Sample commanded vs. actual for control analysis

**Estimated Time:** 4-5 days

**Dependencies:** Phase 1 (buffers)

**Deliverable:** Dynamics modules integrated with telemetry

---

## Phase 8: State Estimation + INS Pipeline

**Goal:** Integrate Kalman filter and sensor fusion

### Tasks

- [ ] **8.1** Integrate stateEstimation library
  - Add as git submodule: `external/stateEstimation`
  - Link in CMakeLists.txt
  - Include headers: `estimators/attitude.h`, `estimators/altitude.h`

- [ ] **8.2** Re-enable ComplementaryEstimatorModule
  - Already exists, just disabled
  - Configure with appropriate gains
  - Ensure it publishes estimated attitude to SimulationState

- [ ] **8.3** Add innovation plots (Kalman diagnostics)
  - Innovation = measurement - prediction
  - Plot innovation for each sensor (accel, gyro, mag)
  - Should be zero-mean white noise if filter is healthy

- [ ] **8.4** Add covariance plots
  - Plot diagonal of covariance matrix over time
  - Shows estimation uncertainty
  - Should converge to steady-state

- [ ] **8.5** Add raw vs. estimated comparison plots
  - Already partially done in Phase 3
  - Ensure all sensors have comparison (not just attitude)
  - Position raw (GPS) vs. estimated (Kalman)

**Estimated Time:** 5-6 days

**Dependencies:** Phase 1 (buffers), Phase 3 (plots)

**Deliverable:** Full INS pipeline with Kalman filter visualization

---

## Phase 9: Controller Integration

**Goal:** Integrate PID/LQR/MPC controllers with tuning UI

### Tasks

- [ ] **9.1** Integrate controlSystems library
  - Add as git submodule: `external/controlSystems`
  - Link in CMakeLists.txt
  - Include headers: `controllers/pid.h`, `controllers/lqr.h`, `controllers/mpc.h`

- [ ] **9.2** Add PID gain tuning sliders to Control Panel
  - Sliders for P, I, D gains (per axis: roll, pitch, yaw)
  - Real-time updates (changes applied immediately)
  - Reset to defaults button

- [ ] **9.3** Add controller mode selector
  - Dropdown or radio buttons: Manual / PID / LQR / MPC / H-Infinity
  - Each mode has different config panel
  - Store active mode in SimulationState.control.controller_mode

- [ ] **9.4** Add commanded vs. actual state plots
  - Overlay commanded attitude (setpoint) with actual attitude
  - Shows tracking performance
  - Useful for tuning (overshoot, settling time visible)

**Estimated Time:** 5-6 days

**Dependencies:** Phase 1 (buffers), Phase 3 (plots), Phase 7 (dynamics)

**Deliverable:** Full control loop with tuning UI

---

## Phase 10: Data Export and Logging

**Goal:** Export telemetry and replay historical data

### Tasks

- [ ] **10.1** Implement CSV export for all buffers
  - Export button in each panel
  - Format: timestamp, field1, field2, ...
  - Use standard CSV library or manual `fprintf`

- [ ] **10.2** Add binary log format (optional)
  - More efficient than CSV for large datasets
  - Fixed-size records for fast seeking
  - Custom format: `[timestamp:double][data:struct]`

- [ ] **10.3** Add log replay functionality
  - Load CSV/binary log file
  - Populate buffers from file instead of simulation
  - Playback controls: play/pause/seek
  - Useful for post-flight analysis

**Estimated Time:** 3-4 days

**Dependencies:** Phase 1 (buffers)

**Deliverable:** Export + replay functionality

---

## Priority Breakdown

### P0 - Must Have (Matches Vision)
These are essential to match the vision mocks:

- Phase 1: Ring buffers ✅
- Phase 2: ImPlot integration ✅
- Phase 3: Attitude plots (TODOs 3.1-3.5) ✅
- Phase 4: Rotor dynamics plots (TODOs 4.1-4.7) ✅
- Phase 5: PBR lighting + skybox (TODOs 5.1-5.3) ✅
- Phase 6: Large metrics + badges (TODOs 6.2, 6.4) ✅

**Estimated: 2-3 weeks**

### P1 - Should Have (Full Loop)
Completes the dynamics → estimation → control pipeline:

- Phase 7: Rotor telemetry (TODO 7.2) ✅
- Phase 8: State estimation (TODOs 8.1-8.5) ✅
- Phase 9: PID controller (TODOs 9.1-9.3) ✅

**Estimated: +2 weeks**

### P2 - Nice to Have (Polish)
Adds cinematic feel and advanced features:

- Phase 5: Vignette + film grain (TODOs 5.5-5.6)
- Phase 6: Navigation tabs (TODO 6.5)
- Phase 7: Full quad EoMs (TODO 7.4)
- Phase 9: LQR/MPC/H-infinity (TODO 9.3)
- Phase 10: CSV export + replay

**Estimated: +1-2 weeks**

---

## Recommended Sequence

### Week 1-2: Data + Plotting Foundation
Focus: Phase 1-2 (ring buffers + ImPlot)

**Deliverable:** Rich data infrastructure, ready to visualize

### Week 2-3: First Visual Milestone
Focus: Phase 3 (attitude plots) + Phase 6 (UI polish)

**Deliverable:** Telemetry panel matching Vision Mock 2

### Week 3-4: Second Visual Milestone
Focus: Phase 4 (rotor dynamics) + Phase 5 (scene polish)

**Deliverable:** Main dashboard matching Vision Mock 1

### Week 4-6: Full Dynamics Loop
Focus: Phase 7-9 (dynamics + estimation + control)

**Deliverable:** Complete INS + control + visualization pipeline

---

## Success Criteria

**Phase 1-2 Complete:**
- [ ] SimulationState has ring buffers for all telemetry
- [ ] ImPlot integrated and working
- [ ] First test plot (Roll angle) renders correctly

**Phase 3-4 Complete:**
- [ ] Estimator panel matches Vision Mock 2
- [ ] Rotor panel matches Vision Mock 1
- [ ] All plots update in real-time

**Phase 5-6 Complete:**
- [ ] 3D scene has cinematic lighting
- [ ] UI matches vision color palette
- [ ] Large metrics and badges look polished

**Phase 7-9 Complete:**
- [ ] Full dynamics loop running
- [ ] Kalman filter converging
- [ ] PID controller stabilizing attitude
- [ ] All plots showing meaningful data

---

## Files to Create/Modify

### New Files
- `src/core/ring_buffer.h` - Ring buffer template
- `src/gui/widgets/plot_widget.h` - ImPlot wrappers
- `src/gui/widgets/metric_display.h` - Large metric component
- `src/gui/widgets/status_badge.h` - Status badge component
- `src/gui/widgets/bar_chart.h` - Bar chart component
- `src/gui/panels/rotor_analysis_panel.h` - Rotor dynamics panel
- `shaders/pbr_lit.vert` - PBR vertex shader
- `shaders/pbr_lit.frag` - PBR fragment shader

### Modified Files
- `src/core/simulation_state.h` - Add history buffers
- `src/app/application.cpp` - Initialize ImPlot, add modules
- `src/gui/panels/estimator_panel.cpp` - Add plots
- `src/gui/panels/control_panel.cpp` - Add PID sliders
- `src/gui/style.cpp` - Update color palette
- `src/render/renderer.cpp` - Add PBR shader, skybox, floor

---

## Next Steps

**Immediate (This Week):**
1. Add ImPlot as submodule
2. Implement ring buffer utility class
3. Add first buffer (quaternion_history) to SimulationState
4. Build proof-of-concept plot (Roll angle)

**Once POC works:**
5. Replicate pattern for all other buffers
6. Build all Phase 3 plots (Estimator panel)
7. Iterate on visual polish to match vision

---

**Roadmap Status:** Draft
**Last Updated:** 2025-10-25
**Next Review:** After Phase 1-2 complete
